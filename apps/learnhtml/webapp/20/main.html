<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Opal Chat - Ultra Minimal</title>
    <style>
        :root {
            --bg: #f6f5f2;
            --ink: #1a1714;
            --soft: rgba(26, 23, 20, 0.08);
            --accent: #e1572a;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            display: grid;
            place-items: center;
            background: var(--bg);
            color: var(--ink);
            font-family: "Sora", "Noto Sans KR", sans-serif;
            padding: 24px 14px;
        }

        .chat {
            width: min(640px, 100%);
            background: white;
            border: 1px solid var(--soft);
            border-radius: 16px;
            display: grid;
            grid-template-rows: 1fr auto;
            min-height: 460px;
            box-shadow: 0 14px 30px rgba(26, 23, 20, 0.1);
        }

        .messages {
            padding: 18px;
            display: grid;
            gap: 10px;
            overflow-y: auto;
        }

        .bubble {
            max-width: 78%;
            padding: 12px 14px;
            border-radius: 14px;
            line-height: 1.5;
            background: #f1efeb;
        }

        .bubble.user {
            justify-self: end;
            background: var(--ink);
            color: #f8f4ef;
        }

        .bubble.math {
            white-space: pre;
            font-family: "JetBrains Mono", "Consolas", "SFMono-Regular", monospace;
        }

        .composer {
            padding: 14px;
            border-top: 1px solid var(--soft);
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
        }

        textarea {
            border: 1px solid var(--soft);
            border-radius: 12px;
            padding: 10px 12px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            min-height: 40px;
        }

        button {
            border: none;
            border-radius: 12px;
            padding: 10px 14px;
            background: var(--accent);
            color: white;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <section class="chat">
        <div class="messages" id="messages">
            <div class="bubble">
                두 개의 숫자와 연산자를 입력하세요. 예: 128+45, 90-12, 7*8, 144/12
            </div>
        </div>

        <div class="composer">
            <textarea id="composer" placeholder="예: 128+45"></textarea>
            <button type="button" id="sendBtn">보내기</button>
        </div>
    </section>

    <script>
        const composer = document.getElementById("composer");
        const sendBtn = document.getElementById("sendBtn");
        const messages = document.getElementById("messages");

        function addBubble(role, text, isMath = false) {
            const bubble = document.createElement("div");
            bubble.className = `bubble ${role}${isMath ? " math" : ""}`.trim();
            bubble.textContent = text;
            messages.appendChild(bubble);
            messages.scrollTop = messages.scrollHeight;
        }

        function formatAddSub(aStr, bStr, op, resultStr) {
            let width = Math.max(aStr.length, bStr.length + 1, resultStr.length);
            const line1 = aStr.padStart(width, " ");
            const line2 = `${op}${bStr.padStart(width - 1, " ")}`;
            const line3 = "-".repeat(width);
            const line4 = resultStr.padStart(width, " ");
            return [line1, line2, line3, line4].join("\n");
        }

        function multiplySteps(aStr, bStr) {
            const a = Number(aStr);
            const b = Number(bStr);
            const productStr = String(a * b);
            const digits = bStr.split("").reverse().map((d) => Number(d));
            const partials = digits.map((digit, idx) => {
                const base = String(a * digit);
                return digit === 0 ? "0".padEnd(idx + 1, "0") : `${base}${"0".repeat(idx)}`;
            });

            let width = Math.max(aStr.length, bStr.length + 1, productStr.length);
            partials.forEach((partial) => {
                width = Math.max(width, partial.length);
            });

            const setup = [
                aStr.padStart(width, " "),
                `x${bStr.padStart(width - 1, " ")}`,
                "-".repeat(width),
            ].join("\n");

            const stepBubbles = [
                `곱셈 설정\n${setup}`,
            ];

            partials.forEach((partial, idx) => {
                const digit = digits[idx];
                const label = `부분곱 ${idx + 1} (×${digit})`;
                stepBubbles.push(
                    `${label}\n${setup}\n${partial.padStart(width, " ")}`
                );
            });

            const final = [
                aStr.padStart(width, " "),
                `x${bStr.padStart(width - 1, " ")}`,
                "-".repeat(width),
                ...partials.map((p) => p.padStart(width, " ")),
                "-".repeat(width),
                productStr.padStart(width, " "),
            ].join("\n");

            stepBubbles.push(`합산\n${final}`);
            return stepBubbles;
        }

        function divideClassicLayout(aStr, bStr) {
            const dividendDigits = aStr.split("").map(Number);
            const divisor = Number(bStr);
            const baseOffset = bStr.length + 3;
            const totalWidth = baseOffset + aStr.length;

            const quotientChars = Array(totalWidth).fill(" ");
            const divisorLine = `${bStr} ) ${aStr}`.padEnd(totalWidth, " ");
            const lines = [];

            let current = 0;
            let started = false;
            let performed = false;

            for (let i = 0; i < dividendDigits.length; i++) {
                current = current * 10 + dividendDigits[i];
                if (!started && current < divisor) {
                    quotientChars[baseOffset + i] = "0";
                    started = true;
                    continue;
                }
                if (started && current < divisor) {
                    quotientChars[baseOffset + i] = "0";
                    continue;
                }

                started = true;
                const qDigit = Math.floor(current / divisor);
                quotientChars[baseOffset + i] = String(qDigit);
                performed = true;

                const product = qDigit * divisor;
                const remainder = current - product;
                const endPos = baseOffset + i;
                const productStr = String(product);
                const productStart = endPos - productStr.length + 1;

                const productLine = (
                    " ".repeat(productStart) + productStr
                ).padEnd(totalWidth, " ");
                const dashLine = (
                    " ".repeat(productStart) + "-".repeat(productStr.length)
                ).padEnd(totalWidth, " ");

                let showValue;
                let showEndPos;
                if (i < dividendDigits.length - 1) {
                    showValue = remainder * 10 + dividendDigits[i + 1];
                    showEndPos = baseOffset + i + 1;
                } else {
                    showValue = remainder;
                    showEndPos = baseOffset + i;
                }

                const showStr = String(showValue);
                const showStart = showEndPos - showStr.length + 1;
                const showLine = (
                    " ".repeat(showStart) + showStr
                ).padEnd(totalWidth, " ");

                lines.push(productLine, dashLine, showLine);
                current = remainder;
            }

            if (!performed) {
                const endPos = baseOffset + aStr.length - 1;
                quotientChars[baseOffset + aStr.length - 1] = "0";
                const productLine = (
                    " ".repeat(endPos) + "0"
                ).padEnd(totalWidth, " ");
                const dashLine = (
                    " ".repeat(endPos) + "-"
                ).padEnd(totalWidth, " ");
                const remainderLine = (
                    " ".repeat(endPos - aStr.length + 1) + aStr
                ).padEnd(totalWidth, " ");
                lines.push(productLine, dashLine, remainderLine);
            }

            const quotientLine = quotientChars.join("");
            return [quotientLine, divisorLine, ...lines].join("\n");
        }

        function handleSend() {
            const text = composer.value.trim();
            if (!text) return;
            addBubble("user", text);
            composer.value = "";
            const match = text.match(/^\s*(-?\d+)\s*([+\-*/xX×÷])\s*(-?\d+)\s*$/);
            if (!match) {
                addBubble(
                    "",
                    "형식이 올바르지 않습니다. 예: 128+45, 90-12, 7*8, 144/12"
                );
                return;
            }

            const [, rawA, rawOp, rawB] = match;
            const a = Number(rawA);
            const b = Number(rawB);
            if (!Number.isFinite(a) || !Number.isFinite(b)) {
                addBubble("", "숫자를 인식할 수 없습니다. 정수를 입력해주세요.");
                return;
            }
            if (a < 0 || b < 0) {
                addBubble("", "현재는 양의 정수 2개만 지원합니다.");
                return;
            }
            if ((rawOp === "/" || rawOp === "÷") && b === 0) {
                addBubble("", "0으로 나눌 수 없습니다.");
                return;
            }

            const op = rawOp === "x" || rawOp === "X" || rawOp === "×" ? "*" : rawOp;
            addBubble("", "세로풀이를 시작합니다.");

            if (op === "+" || op === "-") {
                const result = op === "+" ? a + b : a - b;
                const layout = formatAddSub(String(a), String(b), op, String(result));
                addBubble("", layout, true);
                return;
            }

            if (op === "*") {
                const steps = multiplySteps(String(a), String(b));
                steps.forEach((step) => addBubble("", step, true));
                return;
            }

            const layout = divideClassicLayout(String(a), String(b));
            addBubble("", layout, true);
        }

        sendBtn.addEventListener("click", handleSend);
        composer.addEventListener("keydown", (event) => {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                handleSend();
            }
        });
    </script>
</body>

</html>